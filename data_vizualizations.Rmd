---
title: "Trends & Variations in Transportation Demand in Chicago"
author: "Amir Kazi"
date: "February 2019"
output:
  html_document: 
    code_folding: hide
---

```{r setup, include=FALSE}
library (tidyverse)
library (here)
library(scales)
library(ggrepel)
library(gtools)
library(forcats)
library(sf)
library(lubridate)  # lubridate masks object 'here' from package 'here'.
```

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=10, fig.height=8, echo=FALSE, warning=FALSE, message=FALSE)
```


```{r}
# READING PUBLIC TRANSPORTATION DATA
bus_trips <- read.csv (here::here("data", "bus_data.csv"))
train_trips <- read.csv (here::here("data", "train_data.csv"))

# READING WEATHER DATA
#weather_descriptions <- read.csv(here::here("data", "weather.csv"))
weather <- read.csv(here::here("data", "midway_weather.csv")) 

# READING DIVVY DATA
divvy_trips <- read.csv (here::here("data", "Divvy_Trips1.csv"))

# CREATING PUBLIC TRANSPORTATION DATAFRAME
train_trips$date <- ymd(train_trips$date)
train_trips$dayofweek <- lubridate::wday(train_trips$date, label=TRUE)  
train_trips$day <- day(train_trips$date)
train_trips$month <- lubridate::month(train_trips$date, label = TRUE)
train_trips$year <- year(train_trips$date)

bus_trips$date <- ymd(bus_trips$date)
bus_trips$dayofweek <- lubridate::wday(bus_trips$date, label=TRUE)  
bus_trips$day <- day(bus_trips$date)
bus_trips$month <- lubridate::month(bus_trips$date, label = TRUE)
bus_trips$year <- year(bus_trips$date)

train_trips$trip_identity = 'train'
bus_trips$trip_identity = 'bus'

train_trips$route = NA
bus_trips$station_id = NA
bus_trips$stationname = NA

public_transport = rbind(train_trips,bus_trips)
public_transport = filter (public_transport, year(date) != 2018 )

public_transport$dayofweek <- factor(public_transport$dayofweek, levels = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"))

# SETTING WEATHER DATAFRAME
weather$date <- ymd(weather$DATE)
weather$dayofweek <- lubridate::wday(weather$DATE, label=TRUE)  
weather$day <- day(weather$DATE)
weather$month <- lubridate::month(weather$DATE, label = TRUE)
weather$year <- year(weather$DATE)
weather$dayofyear <- yday(weather$DATE)
```





```{r}
# MY THEME

my_theme <- 
  theme(
    axis.text = element_text(size = 7, face = "bold", family="Courier"),
    axis.title =  element_text(size = 10, face = "bold", family="Courier"),
    plot.title = element_text(hjust = 0, size = 12, face = "bold", family="Courier"), 
    plot.subtitle = element_text(size = 10, face = "bold", family="Courier"),
    plot.caption = element_text(size = 8, face = "bold", family="Courier"),
    legend.title=element_blank(),
    legend.spacing.x = unit(0.2, 'cm'),
    panel.border = element_rect(colour = "#969696", fill=NA, size=2)
    )

# CHOOSING COLOURS FOR TYPE OF TRANSPORTATION
taxi_color <- "#fec44f"  #yellow
divvy_color <- "#6baed6" #blue
bus_color <- "#1B9969" #green
train_color <- "#c51b8a" #violet
winter_color <- "#7a859f"
divvy_female_color <- "#2171b5"
divvy_male_color <- "#6baed6"
```



# PLOT 1: Variation in demand between 2015 - 2017

```{r}
# GETTING TAXI START TIMESTAMPS
taxi_2015 <- read.csv (here::here("data", "2015_Taxi_Trips1.csv"))[,1]
taxi_2016 <- read.csv (here::here("data", "2016_Taxi_Trips1.csv"))[,1]
taxi_2017 <- read.csv (here::here("data", "2017_Taxi_Trips1.csv"))[,1]

taxi_start_times <- mdy_hms(fct_c(taxi_2015, taxi_2016, taxi_2017))
taxi_start_times_date <- as.data.frame(date(taxi_start_times))
colnames(taxi_start_times_date) <- c("date")
remove(taxi_2015, taxi_2016, taxi_2017)


# PUBLIC TRANSPORTATION DEMAND GROUPED BY DAY
public_transport_by_day <-
  public_transport %>%
    group_by(date, trip_identity) %>%
    summarise(riders = sum(rides)) %>%
    select(date, riders, trip_identity)

remove(bus_trips, train_trips)

# DIVVY DEMAND GROUPED BY DAY
divvy_trips$date <- mdy_hms(divvy_trips$START.TIME)

divvy_by_day <-
  divvy_trips %>%
    group_by(date = date(date)) %>%
    summarize (riders = n())

divvy_by_day$trip_identity = 'divvy'

# TAXI DEMAND GROUPED BY DAY
taxi_by_day <-
  taxi_start_times_date %>%
  filter(date != '2017-08-01') %>%
    group_by(date = date) %>%
    summarize (riders = n())

taxi_by_day$trip_identity = 'taxi'

# MERGED DATAFRAME OF TRANSPORTATION
total_demand_by_day <- bind_rows(public_transport_by_day,divvy_by_day, taxi_by_day)
remove(divvy_by_day, public_transport_by_day, taxi_by_day)
```

```{r, warning=FALSE, message=FALSE}
# PLOTTING GRAPH of 3 Year Chicago Public Transportation Trend + Weather


# WINTER
# Shading Winters From 21st December to 30th March
# Reference: https://stackoverflow.com/questions/18419628/creating-custom-legends-in-ggplot2

df<-data.frame(xmin=as.Date(c('2015-01-01','2015-12-21','2016-12-21', '2017-12-21' )),
               xmax=as.Date(c('2015-03-20','2016-03-30', '2017-03-30', '2017-12-31' )),
               ymin=c(-Inf,-Inf),
               ymax=c(Inf,Inf),
               winters=c("Winters"))


total_demand_by_day %>%
  ggplot(aes(x = date, y = riders/1000)) +
  geom_smooth(aes(color = trip_identity), se = FALSE, na.rm = TRUE) +
  geom_rect(data=df,aes(xmin=xmin,ymin=ymin,xmax=xmax,ymax=ymax, fill = 'winters'),
                    alpha=0.15,inherit.aes=FALSE, fill = winter_color) + 
  scale_color_manual(values=c(bus_color,divvy_color, taxi_color, train_color)) +
  scale_x_date(date_labels = "%d %b %Y") +
  theme_bw() +
  my_theme +
  theme(legend.position="none") +
  scale_y_continuous(labels = scales::comma) +
  geom_vline(xintercept = as.Date(c("2015-01-01", "2016-01-01", "2017-01-01", "2018-01-01")), 
             linetype = 4)  +
  annotate("label", x = as.Date("2015-06-01"), y = 500, 
           label = 'TRAIN', color = train_color, fontface =2,  family="Courier")  +
  annotate("label", x = as.Date("2016-06-01"), y = 670, 
           label = 'BUS', color = bus_color, fontface =2,  family="Courier") +
  annotate("label", x = as.Date("2016-06-01"), y = 100, 
           label = 'TAXI', color = taxi_color, fontface =2,  family="Courier") +
  annotate("label", x = as.Date("2015-05-01"), y = 40, 
           label = 'DIVVY', color = divvy_color, fontface =2,  family="Courier")  +
  annotate("label", x = as.Date("2016-03-21"), y = 320, 
           label = 'WINTER', color = winter_color, fontface =2,  family="Courier") +
  labs(title ="Demand for Public Transport & Divvy In Chicago Is Lowest In Winter", 
     subtitle = "Taxi Usage Less Elastic To Seasonal Changes",
     x = "", y = "Passengers Per Day (Thousands)",
     caption = "CTA Ridership Data 2015-2017")

```




# PLOT 2: Hourly Variation in Divvy Demand by Gender

```{r}

divvy_by_gender <- divvy_trips %>%
  filter(GENDER != '') %>%
  group_by(hour_of_day = hour(date), GENDER) %>%
  summarize(riders_by_hour = trunc(n() / (365*3)))


ggplot(data = divvy_by_gender) +
  geom_col(data = subset(divvy_by_gender, GENDER == "Male"), 
           aes(x = hour_of_day, y = riders_by_hour, fill = GENDER), fill = divvy_male_color) +
  geom_col(data = subset(divvy_by_gender, GENDER == "Female"), 
           aes(x = hour_of_day, y = -riders_by_hour, fill = GENDER), fill = divvy_female_color) + 
  scale_fill_brewer(palette = "Set1") + 
  theme_bw() +
  coord_flip() +
  geom_hline(yintercept=0, colour="white", lwd=1) + my_theme + 
  scale_y_continuous( labels = abs) +
  annotate("label", x = 23, y = -150, 
           label = 'FEMALE RIDERS', color = divvy_female_color, fontface =2,  family="Courier") +
  annotate("label", x = 23, y = 300, 
           label = 'MALE RIDERS', color = divvy_male_color, fontface =2,  family="Courier") +
  labs(title ="Highest Demand For Divvy Bikes During Peak Morning & Evening Hours", 
     subtitle = "Significantly Fewer Female Riders, Especially At Night",
     x = "TIME OF DAY", y = "Passengers Per Day",
     caption = "Divvy Ridership Data 2015-2017") + 
  scale_x_continuous(sec.axis = dup_axis()) +
  theme(axis.title.x = element_text(hjust = 0.2))

#remove(divvy_by_gender)
```

# PLOT 3: Public Transport Demand Variation in Winter on snow days and non-snow days

```{r}

winter_dates <- 
  weather %>%
  filter((date >= "2015-01-01" & date <= "2015-03-20") |
           (date >= "2015-12-21" & date <= "2016-03-20") |
           (date >= "2016-12-21" & date <= "2017-03-20") |
           (date >= "2017-12-21" & date <= "2017-12-31"))

snow_days <-
  winter_dates %>% 
  filter (SNOW > 0)

no_snow_days <-
  winter_dates %>% 
  filter (SNOW == 0)
  
train_snow_days <- 
  merge(snow_days, train_trips, by = "date") %>%
  group_by(date) %>%
  summarize (riders = sum(rides)) %>%
  mutate (type = "TRAIN", day_type = "SNOW")

train_no_snow <- 
  merge(no_snow_days, train_trips, by = "date") %>%
  group_by(date) %>%
  summarize (riders = sum(rides)) %>%
  mutate (type = "TRAIN", day_type = "NO SNOW")

bus_snow_days <- 
  merge(snow_days, bus_trips, by = "date") %>%
  group_by(date) %>%
  summarize (riders = sum(rides)) %>%
  mutate (type = "BUS", day_type = "SNOW")

bus_no_snow <- 
  merge(no_snow_days, bus_trips, by = "date") %>%
  group_by(date) %>%
  summarize (riders = sum(rides)) %>%
  mutate (type = "BUS", day_type = "NO SNOW")

snow_comparison <- do.call("rbind", list(train_snow_days, train_no_snow, bus_snow_days,bus_no_snow ))
snow_comparison$day_type <- factor(snow_comparison$day_type, levels = c("SNOW", "NO SNOW"))
remove (train_snow_days, train_no_snow, bus_snow_days,bus_no_snow, snow_days, no_snow_days)

ggplot(snow_comparison) +
  geom_boxplot(aes(x = day_type, y = riders/1000,  fill = type)) + 
  scale_x_discrete(labels = c('Rides Taken on Snow Days \n in Winter',
                              'Rides Taken on Non-Snow Days \n in Winter')) +
  labs(title ="Snow Does NOT Have Much Effect on Ridership in Winter", 
       subtitle = "Cold Non-Snowy Days Seem As Unappealing To Riders",
       x = "", 
       y = "Riders (Thousands)",
       caption = "NCEI & CTA Rider Data 2015-2017") +
  theme_bw() +
  my_theme +
  scale_fill_manual(values=c(bus_color, train_color)) +
  annotate("label", x = 0.8, y = 200, 
           label = 'BUS', color = bus_color, fontface =2,  family="Courier") +
  annotate("label", x = 1.8, y = 120, 
           label = 'BUS', color = bus_color, fontface =2,  family="Courier") +
  annotate("label", x = 1.2, y = 750, 
           label = 'TRAIN', color = train_color, fontface =2,  family="Courier")  +
  annotate("label", x = 2.2, y = 750, 
           label = 'TRAIN', color = train_color, fontface =2,  family="Courier") +
  theme(legend.position="none")
  
```




```{r, warning=FALSE, message=FALSE}
# reference: https://ibecav.github.io/slopegraph/

p <- public_transport %>%
  group_by(year, month, trip_identity) %>%
  summarise(riders = sum(rides)) %>%
  filter (trip_identity == "bus") 

green_palette <- c("#467563", "#1de79a", "#78c679", "#238443","#467563", 
                   "#c2e699", "#78c679", "#238443","#1de79a", "#c2e699", "#78c679", "#238443")

alternative <- c(train_color, divvy_color, taxi_color, winter_color, 
                 "#525252", "#02818a", train_color, 
                 divvy_color, taxi_color, winter_color, "#e31a1c", "#6a51a3")

ggplot(p, aes(x = year, y = riders, group = month)) +
  geom_line(aes(color = month), alpha = 1, size = 1, linetype = 1) +
  geom_point(aes(color = month, alpha = 1), size = 1.5) + 
  scale_colour_manual(values=alternative) +
  geom_label_repel(data = p %>% filter(year == "2015"),
                  aes(label = paste0(month), color = month, family = "Courier", fontface = 2) , 
                  hjust = "left", 
                  fontface = 7, 
                  size = 3, 
                  nudge_x = -.45, 
                  direction = "y") +
  geom_label_repel(data = p %>% filter(year == "2017"),
              aes(label = paste0(month), color = month, family = "Courier", fontface = 2) , 
              hjust = "right", 
              fontface = 7, 
              size = 2.5, 
              nudge_x = .4,
              direction = "y") +
  scale_x_discrete(position = "bottom") +
  theme_bw() +
  theme(legend.position = "none") + 
    annotate("label", x = 2015, y = 20000000, label = "2015", 
             family = "Courier", fontface =2, fill = bus_color, color = "white")  + 
    annotate("label", x = 2016, y = 24000000, label = "2016",
             fontface =2, family = "Courier", fill = bus_color, color = "white") +  
    annotate("label", x = 2017, y = 23500000, label = "2017",
             fontface =2, family = "Courier", fill = bus_color, color = "white") +
  theme(panel.border     = element_blank()) +
  theme(axis.title.x     = element_blank()) +
  theme(axis.text.y     = element_blank()) +
  theme(axis.ticks   = element_blank()) +
    my_theme +
  labs( title = "Overall Bus Usage Has Declined Between 2015 and 2017",
    subtitle = "Summer Months still experience more bus usage than in Winter",
    caption = "CTA Transit Data 2015 - 2017",
    y = "Total Bus Riders") +
  theme(plot.title = element_text(hjust = 0.58, size = 12, face = "bold"), 
        plot.subtitle = element_text(hjust = 0.515, size = 10, face = "bold")) + 
    scale_y_continuous(labels = scales::comma) 

```

